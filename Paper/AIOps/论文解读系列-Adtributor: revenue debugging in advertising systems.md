## 1. 摘要

广告收入在支持免费网站方面起着至关重要的作用。当收入出现急剧下降或增加时，广告系统运营商必须找到根本原因并解决（如果可行的话）。例如，通过优化基础设施性能。这种收入调试类似于系统文献中的诊断和根本原因分析，但更为普遍。基础设施的故障只是其中一个潜在的原因，许多其他维度（例如，广告商、设备类型）也可能是潜在的原因。此外，每次点击成本等派生指标也会使问题复杂化，因为这些指标也会与收入一起被跟踪。

该论文首次系统地探讨了收入调试问题。利用解释力、简洁性和惊喜等概念，我们提出了一种新的多维根因算法，用于广告系统的基本和派生指标以确定最有可能归咎于的维度。此外，我们在一个名为 Adtributor 的工具中实现了该归因算法以及可视化界面，以帮助故障排除人员快速识别潜在原因。基于对超大型广告系统的多个案例研究和广泛的评估，我们表明 Adtributor 的准确率超过 95%，并有助于将故障排除时间缩短一个数量级。

## 2. 简介

今天许多免费网站都是靠广告收入来支撑的。网站广告有两种类型，即搜索广告和展示广告。在搜索广告的场景下，终端用户访问诸如 `bing.com` 等广告主网站，并输入一个查询短语进行搜索。搜索结果页面可能包含一个或多个广告。如果用户点击其中一个广告，广告主就会获得收入。在展示广告的场景下，终端用户可能会访问一个广告主网站，比如 `cnn.com`，并在页面的顶部或两侧看到广告。这些广告的展示为广告主带来了收入。

广告系统每天为数百万这样的搜索和展示广告提供生成和结算。除了上面提到的用户和广告主，还有另外两个与广告系统交互的关键实体：**广告商**和**欺诈经营者**。向用户展示的广告是不同广告商之间竞价竞标的结果，这些广告商竞相出价以获得他们的广告显示给用户。此外，还有各种各样的欺诈经营者试图篡夺一小部分广告收入。

广告系统管理用户、广告主、广告商和欺诈经营者之间的交互。广告系统执行各种与广告相关的算法，在广告商之间运行实时广告拍卖，将获胜的广告返回给广告主，监控用户点击，检测并删除潜在的欺诈活动，计算每个展示或点击广告的收入，并向广告商收取适当的出价金额，以及向广告主支付费用。广告系统的核心是一个大型分布式系统，由分布在多个数据中心的数千台服务器组成，这些服务器执行广告算法并管理广告的服务和计费。

本文的重点是调试广告系统。通常情况下，广告系统监控器会在发现相关指标出现异常时发出警报(例如，收入或搜索数量急剧下降)。我们的目标是自动找出这种异常的潜在根因。我们将我们的方法称为`收入调试`，来确认收入指标的正确性，尽管这个方法也适用于广告系统运营商所关心的多个指标。在本文中，我们介绍了一种新的收入调试算法，该算法分析了广告系统记录的大量数据，并将异常的潜在根本原因的范围缩小到广告系统的一个子组件，以便人工故障排除员进一步排查。

根因识别和诊断是系统中一个古老的问题。过去已经提出了各种各样的性能根因工具。但所有这些解决方案都侧重于性能/故障排查。在这里，我们解决一个类似但更常见的问题:广告系统中的诊断。虽然基础设施系统组件的性能/故障可能是异常检测的一个可能的根因，但也可能是依赖于与广告系统交互的其他组件的各种根因。例如如下所示例子：

- 教皇选举：
  - 我们注意到教皇选举导致收入下降，是因为许多搜索都是针对非货币化的查询词，如教皇或教皇选举，而这些词广告商通常不会竞标。展示的广告总数下降，导致收入异常下降。虽然将根因确定为教皇选举是不可操作的，但能确定根因仍然是很重要的，因为它消除了可操作的根因，如下面的例子。
- 浏览器广告故障：我们发现收入下降是由于更新配置文件时的手动错误造成的，该错误会导致在某些浏览器版本上无法展示广告。在这种情况下，快速识别有助于纠正配置错误，从而恢复广告收入。

广告系统调试的第一个挑战是数据的规模。每天都有数以亿计的搜索和点击，在搜索或点击级别执行诊断是不可扩展的。因此，出于可扩展性的原因，广告系统调试是通过聚合不同指标操作实现的。这些指标通常是在特定时间间隔内汇总的计数，例如过去1小时内产生的收入。只有这些汇总的计数出现异常行为才会触发根因识别。

与传统的系统故障诊断相比，广告系统的第二个显著特征是存在多个维度，并且需要首先区分解释异常的维度。诸如收入之类的指标可以按照不同的维度(如广告商、浏览器或数据中心)进行分解或预测。例如，在例2中，如果按照浏览器维度来拆解，可以观察到一些浏览器版本没有产生"典型"的收入份额。但是，如果同样的收入按照广告商维度切分，收入的分布可能不会有显著的变化。典型的系统根源算法，如 [SCORE]()，使用简洁性(奥卡姆剃刀)和解释力(根因能否解释变化吗?)作为优化的主要参数，而没有考虑多个维度。对于区分异常维度，我们引入了惊喜的概念，通过量化每个维度上测量值分布的变化来捕获。例如，在例2中，沿着浏览器维度的收入分布变化比沿着广告商维度的收入分布变化更令人惊讶。因此，我们在本文中的第一个贡献是第3节中描述的根因算法，该算法除了简洁和解释力之外，还使用惊喜来识别广告系统中的根因。

广告系统的第三个特点是派生指标的普遍性。考虑两个基本指标：每小时收入和每小时点击数。根据这两个指标，我们可以定义一个叫做'每次点击成本'的派生指标，即收入除以点击次数。广告系统运营商监控和跟踪许多这样的派生指标，这些指标是各种基本指标的函数(见图1)。例如，点击次数和收入变化本身可能很小，并不反常(例如，小于10%)。然而，相关的变化(例如，收益下降，同时点击量增加，各 10%)，这就是一个异常现象，可以通过每次点击成本这个派生指标(20% 的变化)来捕捉。正如我们在第4节中讨论的那样，将根因归因于派生指标是具有挑战性的。为了解决这个问题，我们为派生指标提出了一种新的部分派生归因解决方案，这是我们论文的第二个贡献。

我们的根因识别算法的结果是一组可能解释异常的候选。然而，这只是诊断过程中的第一步，在此过程中，故障排除程序可能会采取适当的措施来解决问题。为了帮助故障排除人员快速识别潜在的根因候选，我们在一个名为 Adtributor 的工具中实现了我们的根因识别算法和图形可视化工具，这是我们论文的第三个贡献。通过在生产系统中试点部署的经验，我们改进了 Adtributor 中的可视化界面和数据表示技术，以进一步缩短故障排除程序的周转时间。

最后，我们对我们的根因算法进行了广泛的评估。首先，我们列出并讨论了一组具有代表性的研究案例，这些研究案例突出了我们的根因工具的价值。其次，我们对两周真实广告系统数据中的 128 个异常警报进行了评估，发现我们的算法达到了95%以上的准确率。事实上，Adtributor 甚至还发现人工故障排除人员遗漏的一些异常的根因。此外，该工具还将故障排除过程的速度提高了一个数量级

## 3. 问题陈述

在本节中，我们首先介绍了系统概述，然后我们举例说明一个实际问题以及其根因。接下来，我们更精确地陈述问题并提出我们的解决方案

### 3.1 系统概述

图1展示了一个简化的广告系统，以及与广告系统直接交互的实体，如用户、欺诈经营者、广告主和广告商。广告系统本身有各种子组件，我们将展示其中的一些。

虽然日志基础设施会跟踪每一个搜索请求或广告点击，但由于其规模之大使得很难在单个请求级别发现问题。相反，系统会监控一系列聚合指标，如图1所示。从原始日志中，首先计算每个时间间隔接收到的总搜索量、展示的总广告量、接收到的总广告点击量以及这些点击产生的总收入。这些指标都是相加的，并且可以按照不同的维度拆分。例如，总收入是使用该系统的每个广告客户的收入总和。总收入也是来自广告系统活跃的不同地区的收入总和。我们称这种加法计量为基本计量。此外，系统还会监控一系列的非相加的派生指标，这些指标是基本指标的函数，如每次搜索的广告(`广告/搜索`)、每次广告的点击(`点击/广告`)、每次点击成本(`收入/点击`)和每次搜索收入(`收入/搜索`)。

任何一项指标的异常上升或下降都表明存在问题。因此，诊断引擎需要首先检测异常，然后进行根因分析。在本文中，我们关注的是根因分析这一后一方面，同时依赖于众所周知的基于 ARMA 模型的方法[4]()进行异常检测。异常检测器根据8周的历史数据生成基于模型的测量值预测，同时考虑到正常的时间波动和星期波动。然后，它将实际值与预测值进行比较，当测量值的实际值与预测值有很大差异时，就会生成异常警报。我们生成警报的阈值差异是根据期望值的百分比偏差来测量的。在当前系统中，故障排除人员根据经验手动设置此值。对于每个警报，我们的目标是将指标中的异常归因于一个维度及其相应的元素。接下来我们定义这些术语：

- 维度：
  - 维度是一个轴线，沿着这个轴线可以投影一个测量值。例如，我们可以沿着广告客户的轴线来投射收入，并确定每个广告客户的收入。这种情况下的维度是`广告商`。派生的指标可以类似地跨维度进行投影。其他维度包括`广告主`、`数据中心`和`用户位置`。一般来说，一个广告系统要处理几十个这样的维度。注意，1美元的收益可以在一个维度中添加到广告商1，在第二个维度中添加到广告主3
- 元素：
  - 每个维度都有一个称为元素的值域。例如，"广告商"域包含以下元素:`{Geico, Microsoft, Toyota,Frito-Lay，…}`。"广告主"维度包含如下元素:`{Bing, Amazon, NetFlix，…}`。

表1提供了我们遇到的一些问题示例，包括可操作和不可操作的问题，需要对相应的维度和要素进行检测并找出根因。第1列展示问题可能发生在不同层面。第3列展示了异常度量。第4列为本文重点分析的根因分析结果。需要注意的是，第4列只是找出根因的第一步，但它至关重要，因为它为故障排除人员提供了问题实际所在的最佳提示。其他后处理技术(相关引擎、NLP技术、人工调查)使用多维分析的输出来更深入地挖掘，以找到最终的根因，如第5列所示，但这方面的根因超出了本文的范围。例如，在第9行中，虽然多维分析确实将问题缩小到几个查询字符串，但管理员必须从语义上解释这些字符串，才能确定根因是教皇选举。

### 3.2 问题定义和范围

收益调试的多维分析问题是找到最能解释某一指标异常涨跌的维度及其要素。在本文中，我们需要定义什么构成了异常的"最佳解释"。请看下面的例子。广告系统在某一特定时间的收益预计为100美元。实际收入只有50美元。收入指标触发了警报，从而使故障排除人员注意到问题。当此类问题发生时，为了找到根因，广告系统会持续跟踪多个维度产生的收入。对于这个场景，考虑三个维度：数据中心(DC)、广告商(AD)和设备类型(DT)。表2、3、4展示了按照这些维度的收入值预测，以及归属于各个元素的值。

| 数据中心 | 预测收入 | 实际收入 | 差异  |
|:----:|:----:|:----:|:---:|
| X    | $94  | $47  | $47 |
| Y    | $6   | $3   | $3  |
| 总计   | $100 | $50  | $50 |

> 表1

| 广告商 | 预测收入 | 实际收入 | 差异  |
|:---:|:----:|:----:|:---:|
| A1  | $50  | $24  | $26 |
| A2  | $20  | $21  | -$1 |
| A3  | $20  | $4   | $16 |
| A4  | $10  | $1   | $9  |
| 总计  | $100 | $50  | $50 |

> 表2

| 设备类型 | 预测收入 | 实际收入 | 差异  |
|:----:|:----:|:----:|:---:|
| 个人电脑 | $50  | $49  | $1  |
| 手机 | $25  | $1   | $24 |
| 平板电脑 | $25  | $0   | $25 |
| 总计   | $100 | $50  | $50 |

> 表3

现在我们解释这些属性的语义。当广告系统接收到搜索查询时，它将查询路由到数据中心，数据中心反过来提供大量广告作为响应。归属于数据中心的收入是通过该数据中心所提供的广告点击所获得的总收入。每个广告都有一个关联的广告主。当用户点击广告时，系统会向广告商收取预先确定的费用。归于广告商的收入是广告商广告点击的总成本。用户可以使用多种设备(可能是手机、平板电脑或个人电脑)进行搜索查询。归属于设备类型的收入是广告系统从该该设备类型的广告点击中获得的所有收入的总和。

我们想要回答的问题是：我们如何将收入下降精确到正确的维度及其要素?我们将问题重申如下。"找到一个布尔表达式，以维度和要素为单位，使归因于该表达式的收入下降最好地解释了总收入的下降。"当我们研究如何确定"最佳"时，请考虑如下表达式，它们可以解释50美元收入下降：



...
