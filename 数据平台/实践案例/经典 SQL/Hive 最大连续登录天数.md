
## 1. 数据准备

```sql
CREATE  TABLE IF NOT EXISTS user_login(
  uid string,
  login_time string
)
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n';
```

```
10001,2022-10-01 10:51:38
10002,2022-10-01 14:06:31
10003,2022-10-01 14:59:19
10002,2022-10-02 02:30:46
10001,2022-10-02 09:42:50
10004,2022-10-02 20:34:31
10002,2022-10-03 12:11:37
10004,2022-10-03 18:51:49
10003,2022-10-03 11:25:41
10004,2022-10-04 04:44:31
10001,2022-10-04 08:14:04
10003,2022-10-04 19:40:12
10001,2022-10-05 08:42:27
10004,2022-10-05 09:00:22
10001,2022-10-06 12:38:00
10002,2022-10-06 15:25:04
10004,2022-10-06 20:15:27
10001,2022-10-07 10:25:17
10003,2022-10-07 20:29:36
```


```sql
load data local inpath '/opt/data/user_login.txt' overwrite into table user_login;
```

## 2. 连续登录天数

- 使用 ROW_NUMBER 在组内给数据编号 idx
- 登录日期 - idx

```sql
SELECT
  uid, login_time,
  ROW_NUMBER() OVER (PARTITION BY uid ORDER BY login_time) AS idx
FROM user_login;
```
输出：
```
10001	2022-10-01 10:51:38	1
10001	2022-10-02 09:42:50	2
10001	2022-10-04 08:14:04	3
10001	2022-10-05 08:42:27	4
10001	2022-10-06 12:38:00	5
10001	2022-10-07 10:25:17	6
10002	2022-10-01 14:06:31	1
10002	2022-10-02 02:30:46	2
10002	2022-10-03 12:11:37	3
10002	2022-10-06 15:25:04	4
10003	2022-10-01 14:59:19	1
10003	2022-10-03 11:25:41	2
10003	2022-10-04 19:40:12	3
10003	2022-10-07 20:29:36	4
10004	2022-10-02 20:34:31	1
10004	2022-10-03 18:51:49	2
10004	2022-10-04 04:44:31	3
10004	2022-10-05 09:00:22	4
10004	2022-10-06 20:15:27	5
```

```sql
SELECT uid, login_time, date_sub(login_time, idx)
FROM (
  SELECT
    uid, login_time,
    ROW_NUMBER() OVER(PARTITION BY uid ORDER BY login_time) AS idx
  FROM user_login
) AS a;
```
输出：
```
10001	2022-10-01 10:51:38	2022-09-30
10001	2022-10-02 09:42:50	2022-09-30
10001	2022-10-04 08:14:04	2022-10-01
10001	2022-10-05 08:42:27	2022-10-01
10001	2022-10-06 12:38:00	2022-10-01
10001	2022-10-07 10:25:17	2022-10-01

10002	2022-10-01 14:06:31	2022-09-30
10002	2022-10-02 02:30:46	2022-09-30
10002	2022-10-03 12:11:37	2022-09-30
10002	2022-10-06 15:25:04	2022-10-02

10003	2022-10-01 14:59:19	2022-09-30
10003	2022-10-03 11:25:41	2022-10-01
10003	2022-10-04 19:40:12	2022-10-01
10003	2022-10-07 20:29:36	2022-10-03

10004	2022-10-02 20:34:31	2022-10-01
10004	2022-10-03 18:51:49	2022-10-01
10004	2022-10-04 04:44:31	2022-10-01
10004	2022-10-05 09:00:22	2022-10-01
10004	2022-10-06 20:15:27	2022-10-01
```

```sql
SELECT
  uid, group_id,
  MIN(login_time) AS min_login_time,
  MAX(login_time) AS max_login_time,
  COUNT(*) AS days
FROM (
  SELECT uid, login_time, date_sub(login_time, idx) AS group_id
  FROM (
    SELECT
      uid, login_time,
      ROW_NUMBER() OVER(PARTITION BY uid ORDER BY login_time) AS idx
    FROM user_login
  ) AS a
) AS b
GROUP BY uid, group_id;
```
输出：
```
10001	2022-09-30	2022-10-01 10:51:38	2022-10-02 09:42:50	2
10001	2022-10-01	2022-10-04 08:14:04	2022-10-07 10:25:17	4
10002	2022-09-30	2022-10-01 14:06:31	2022-10-03 12:11:37	3
10002	2022-10-02	2022-10-06 15:25:04	2022-10-06 15:25:04	1
10003	2022-09-30	2022-10-01 14:59:19	2022-10-01 14:59:19	1
10003	2022-10-01	2022-10-03 11:25:41	2022-10-04 19:40:12	2
10003	2022-10-03	2022-10-07 20:29:36	2022-10-07 20:29:36	1
10004	2022-10-01	2022-10-02 20:34:31	2022-10-06 20:15:27	5
```

## 3. 最大连续登录天数

```sql
SELECT
  uid, min_login_time, max_login_time, days
FROM (
  SELECT
    uid, min_login_time, max_login_time, days,
    ROW_NUMBER() OVER(PARTITION BY uid ORDER BY days DESC) AS idx
  FROM (
    SELECT
      uid, date_sub(login_time, idx) AS group_id,
      MIN(login_time) AS min_login_time,
      MAX(login_time) AS max_login_time,
      COUNT(*) AS days
    FROM (
      SELECT
        uid, login_time,
        ROW_NUMBER() OVER(PARTITION BY uid ORDER BY login_time) AS idx
      FROM user_login
    ) AS a
    GROUP BY uid, date_sub(login_time, idx)
  ) AS b
) AS c
WHERE idx = 1;
```
输出：
```
10001	2022-10-04 08:14:04	2022-10-07 10:25:17	4
10002	2022-10-01 14:06:31	2022-10-03 12:11:37	3
10003	2022-10-03 11:25:41	2022-10-04 19:40:12	2
10004	2022-10-02 20:34:31	2022-10-06 20:15:27	5
```
