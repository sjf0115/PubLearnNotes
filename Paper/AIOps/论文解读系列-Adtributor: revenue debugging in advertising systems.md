## 1. 摘要

广告收入在支持免费网站方面起着至关重要的作用。当收入出现急剧下降或增加时，广告系统运营商必须找到根本原因并解决（如果可行的话）。例如，通过优化基础设施性能。这种收入调试类似于系统文献中的诊断和根本原因分析，但更为普遍。基础设施的故障只是其中一个潜在的原因，许多其他维度（例如，广告商、设备类型）也可能是潜在的原因。此外，每次点击成本等派生指标也会使问题复杂化，因为这些指标也会与收入一起被跟踪。

该论文首次系统地探讨了收入调试问题。利用解释力、简洁性和惊喜等概念，我们提出了一种新的多维根因算法，用于广告系统的基本和派生指标以确定最有可能归咎于的维度。此外，我们在一个名为 Adtributor 的工具中实现了该归因算法以及可视化界面，以帮助故障排除人员快速识别潜在原因。基于对超大型广告系统的多个案例研究和广泛的评估，我们表明 Adtributor 的准确率超过 95%，并有助于将故障排除时间缩短一个数量级。

## 2. 简介

今天许多免费网站都是靠广告收入来支撑的。网站广告有两种类型，即搜索广告和展示广告。在搜索广告的场景下，终端用户访问诸如 `bing.com` 等发布者网站，并输入一个查询短语进行搜索。搜索结果页面可能包含一个或多个广告。如果用户点击其中一个广告，发布者就会获得收入。在展示广告的场景下，终端用户可能会访问一个发布者网站，比如 `cnn.com`，并在页面的顶部或两侧看到广告。这些广告的展示为发布者带来了收入。

广告系统每天为数百万这样的搜索和展示广告提供生成和结算。除了上面提到的用户和发布者，还有另外两个与广告系统交互的关键角色：**广告商**和**欺诈经营者**。向用户展示的广告是不同广告商之间竞价竞标的结果，这些广告商竞相出价以获得他们的广告显示给用户。此外，还有各种各样的欺诈经营者试图篡夺一小部分广告收入。

广告系统管理用户、发布者、广告商和欺诈经营者之间的交互。广告系统执行各种与广告相关的算法，在广告商之间运行实时广告拍卖，将获胜的广告返回给发布者，监控用户点击，检测并删除潜在的欺诈活动，计算每个展示或点击广告的收入，并向广告商收取适当的出价金额，以及向发布者支付费用。广告系统的核心是一个大型分布式系统，由分布在多个数据中心的数千台服务器组成，这些服务器执行广告算法并管理广告的服务和计费。

本文的重点是调试广告系统。通常情况下，广告系统监控器会在发现相关指标出现异常时发出警报(例如，收入或搜索数量急剧下降)。我们的目标是自动找出这种异常的潜在根因。我们将我们的方法称为`收入调试`，来确认收入指标的正确性，尽管这个方法也适用于广告系统运营商所关心的多个指标。在本文中，我们介绍了一种新的收入调试算法，该算法分析了广告系统记录的大量数据，并将异常的潜在根本原因的范围缩小到广告系统的一个子组件，以便人工故障排除员进一步排查。

根因识别和诊断是系统中一个古老的问题。过去已经提出了各种各样的性能根因工具。但所有这些解决方案都侧重于性能/故障排查。在这里，我们解决一个类似但更常见的问题:广告系统中的诊断。虽然基础设施系统组件的性能/故障可能是异常检测的一个可能的根因，但也可能是依赖于与广告系统交互的其他组件的各种根因。例如如下所示例子：
- 教皇选举：
  - 我们注意到教皇选举导致收入下降，是因为许多搜索都是针对非货币化的查询词，如教皇或教皇选举，而这些词广告商通常不会竞标。展示的广告总数下降，导致收入异常下降。虽然将根因确定为教皇选举是不可操作的，但能确定根因仍然是很重要的，因为它消除了可操作的根因，如下面的例子。
- 浏览器广告故障：我们发现收入下降是由于更新配置文件时的手动错误造成的，该错误会导致在某些浏览器版本上无法展示广告。在这种情况下，快速识别有助于纠正配置错误，从而恢复广告收入。

广告系统调试的第一个挑战是数据的规模。每天都有数以亿计的搜索和点击，在搜索或点击级别执行诊断是不可扩展的。因此，出于可扩展性的原因，广告系统调试是通过聚合不同指标操作实现的。这些指标通常是在特定时间间隔内汇总的计数，例如过去1小时内产生的收入。只有这些汇总的计数出现异常行为才会触发根因识别。

与传统的系统故障诊断相比，广告系统的第二个显著特征是存在多个维度，并且需要首先区分解释异常的维度。诸如收入之类的指标可以按照不同的维度(如广告商、浏览器或数据中心)进行分解或预测。例如，在例2中，如果按照浏览器维度来拆解，可以观察到一些浏览器版本没有产生"典型"的收入份额。但是，如果同样的收入按照广告商维度切分，收入的分布可能不会有显著的变化。典型的系统根源算法，如 [SCORE]()，使用简洁性(奥卡姆剃刀)和解释力(根因能否解释变化吗?)作为优化的主要参数，而没有考虑多个维度。对于区分异常维度，我们引入了惊喜的概念，通过量化每个维度上测量值分布的变化来捕获。例如，在例2中，沿着浏览器维度的收入分布变化比沿着广告商维度的收入分布变化更令人惊讶。因此，我们在本文中的第一个贡献是第3节中描述的根因算法，该算法除了简洁和解释力之外，还使用惊喜来识别广告系统中的根因。

广告系统的第三个特点是派生指标的普遍性。考虑两个基本指标：每小时收入和每小时点击数。根据这两个指标，我们可以定义一个叫做'每次点击成本'的派生指标，即收入除以点击次数。广告系统运营商监控和跟踪许多这样的派生指标，这些指标是各种基本指标的函数(见图1)。例如，点击次数和收入变化本身可能很小，并不反常(例如，小于10%)。然而，相关的变化(例如，收益下降，同时点击量增加，各 10%)，这就是一个异常现象，可以通过每次点击成本这个派生指标(20% 的变化)来捕捉。正如我们在第4节中讨论的那样，将根因归因于派生指标是具有挑战性的。为了解决这个问题，我们为派生指标提出了一种新的部分派生归因解决方案，这是我们论文的第二个贡献。

我们的根因识别算法的结果是一组可能解释异常的候选。然而，这只是诊断过程中的第一步，在此过程中，故障排除程序可能会采取适当的措施来解决问题。为了帮助故障排除人员快速识别潜在的根因候选，我们在一个名为 Adtributor 的工具中实现了我们的根因识别算法和图形可视化工具，这是我们论文的第三个贡献。通过在生产系统中试点部署的经验，我们改进了 Adtributor 中的可视化界面和数据表示技术，以进一步缩短故障排除程序的周转时间。

最后，我们对我们的根因算法进行了广泛的评估。首先，我们列出并讨论了一组具有代表性的研究案例，这些研究案例突出了我们的根因工具的价值。其次，我们对两周真实广告系统数据中的 128 个异常警报进行了评估，发现我们的算法达到了95%以上的准确率。事实上，Adtributor 甚至还发现人工故障排除人员遗漏的一些异常的根因。此外，该工具还将故障排除过程的速度提高了一个数量级




...
