

在开创性的 System R 之后，传统的关系数据库引擎主导了数据处理领域。然而，早在 2005 年，Stonebraker 和 Çetintemel 就预测我们会看到一系列有特性的引擎的出现，例如列式存储，流处理引擎，文本搜索引擎等等。他们认为这些专用的引擎可以提供更具成本效益的性能，并且终结 `One size fits all` 的模式。现在已经有许多专门的开源数据系统越来越流行，如 Storm 和 Flink（流处理），Elasticsearch（文本搜索），Apache Spark，Druid 等。随着投资于针对其特定需求量身定制的数据处理系统，出现了两个主要问题：
- 这些专用系统的开发人员会遇到查询优化的问题、需要像 SQL 以及相关扩展(例如流查询、LINQ 的语言集成查询)查询语言的支持。如果没有统一的框架，每个开发工程师都独立开发类似的优化逻辑和支持语言会大大浪费人力。
- 使用这些专用系统的程序员通常必须将其中的几个集成在一起使用。可能依赖 Elasticsearch，Apache Spark 或者 Druid。我们需要构建能够支持跨异构数据源的优化查询的系统。

Apache Calcite 是为解决这些问题而开发的。它是一个完整的查询处理系统，提供了许多常见功能：查询执行，查询优化以及查询语言，这是任何数据库管理系统都需要的功能，但是不提供数据存储和管理功能，留给专用引擎来实现。Calcite 很快被 Hive、Drill、Storm 以及许多其他数据处理引擎采用了，为它们提供了高级查询优化和查询语言。例如，Hive 是一个建立在 Apache Hadoop 之上的流行数据仓库项目。随着 Hive 从批处理转向交互式 SQL 查询平台，很明显这个项目核心需要一个强大的优化器。因此，Hive 采用 Calcite 作为它的优化器，并且它们之间的集成越来越紧密。许多其他项目和产品也纷纷效仿，包括 Flink，MapD 等。

此外，Calcite 通过向多个系统暴露一个通用接口来实现跨平台优化。为了保证效率，优化器需要全局推理，例如，在物化视图跨不同系统中做出决策。建立一个通用框架并非没有挑战。特别是，框架需要有足够的可扩展性和灵活性来适应不同类型的集成系统。我们相信如下特性有助于 Calcite 在开源社区和行业中的广泛采用：
- 开源友好
  - 过去十年中，许多主要的数据处理平台要么是开源的，要么很大程度上是基于开源的。Calcite 是一个 Apache 软件基金会(ASF)孵化的开源框架，提供了协作开发项目的手段。此外，该软件由 Java 编写，更易与许多最新的数据处理系统（它们也大都由 Java 编写）进行集成，尤其是那些在 Hadoop 生态系统里的。
- 多种数据模型
  - Calcite 提供对查询优化和查询语言的支持，同时使用流和常规数据处理范例。Calcite 将流视为有时间顺序的记录或事件集合，这些记录或事件不像传统数据处理系统那样持久保存到磁盘。
- 灵活的查询优化器
  - 从规则到成本模型，优化器的每个组件都是可插拔和可扩展的。此外，Calcite 还支持多个计划引擎。因此，优化可以分解为由不同优化引擎处理的阶段，这取决于哪一个最适合该阶段。
- 跨系统支持
  - Calcite 框架可以跨多个查询处理系统和数据库后端来运行和优化查询。
- 可靠性
  - Calcite 是可靠的，因为它多年来的广泛使用导致了该平台的详尽测试。Calcite 还包含了一个涵盖很广的测试套件，用于验证系统的所有组件，包括查询优化器规则以及与后端数据源的集成。
- 支持 SQL 以及扩展
  - 许多系统都不提供自己的查询语言，而是更喜欢依赖现有的查询语言，例如 SQL。Calcite 提供对 ANSI 标准 SQL 的支持，以及各种 SQL 方言和扩展，例如，用于表达对流或嵌套数据的查询。此外，Calcite 还包含符合标准 Java API（JDBC）的驱动程序。


Apache Calcite 是一个独立于存储与执行的SQL优化引擎，目前广泛应用于开源大数据计算引擎中，如 Flink、Drill、Kylin等。Calcite的目标是“一种方案适用于所有需求场景”，旨在为不同的计算平台和数据源提供统一的查询引擎。如上图所示，Calcite的架构不包括存储和执行。整体流程是一个SQL statement通过JDBC Client进入JDBC Server后，经过SQL Parser 和Validator后生成关系代数表达式（Operator Expressions）。除此之外，用户还可以使用Expressions Builder生成SQL的关系代数表达式，这适用于有自己特定语法的系统。生成的关系代数表达式会进入查询优化器核心引擎（Query Optimizer），负责执行动态规划算法和Cost计算。Calcite还提供一些可插拔的功能，如Metadata Providers（为优化引擎提供Metadata）和Pluggable Rules（支持用户自定义优化规则）。

什么是Calcite

Apache Calcite是一个动态数据管理框架，它具备很多典型数据库管理系统的功能，比如SQL解析、SQL校验、SQL查询优化、SQL生成以及数据连接查询等，但是又省略了一些关键的功能，比如Calcite并不存储相关的元数据和基本数据，不完全包含相关处理数据的算法等。


Apache Calcite 是一个基础软件框架，能够为许多流行的开源数据处理系统提供查询处理、查询优化以及查询语言的支持，例如 Apache Hive、Apache Storm、Apache Flink、Druid 以及 MapD 等等。



也正是因为Calcite本身与数据存储和处理的逻辑无关，所以这让它成为与多个数据存储位置（数据源）和多种数据处理引擎之间进行调解的绝佳选择。

Calcite所做的工作就是将各种SQL语句解析成抽象语法树（AST Abstract Syntax Tree），并根据一定的规则或成本对AST的算法与关系进行优化，最后推给各个数据处理引擎进行执行。

目前，使用Calcite作为SQL解析与优化引擎的又Hive、Drill、Flink、Phoenix和Storm，Calcite凭借其优秀的解析优化能力，会有越来越多的数据处理引擎采用Calcite作为SQL解析工具。

Calcite 主要功能

Calcite的主要功能我们上面其实已经提到了，主要有以下功能：

SQL解析：通过JavaCC将SQL解析成未经校验的AST语法树

SQL校验：校验分两部分，一种为无状态的校验，即验证SQL语句是否符合规范；一种为有状态的即通过与元数据结合验证SQL中的Schema、Field、Function是否存在。

SQL查询优化：对上个步骤的输出（RelNode）进行优化，得到优化后的物理执行计划

SQL生成：将物理执行计划生成为在特定平台/引擎的可执行程序，如生成符合Mysql or Oracle等不同平台规则的SQL查询语句等

数据连接与执行：通过各个执行平台执行查询，得到输出结果。
