---
layout: post
author: smartsi
title: ANTLR4 å¦‚ä½•ç¼–å†™è¯­æ³•æ–‡ä»¶ä¹‹è¯­æ³•è¯æ±‡
date: 2023-01-03 15:15:01
tags:
  - Antlr

categories: Antlr
permalink: antlr-grammar-lexicon
---

ANTLR ä¸­çš„è¯æ±‡å¤§å¤šæ•°ç¨‹åºå‘˜å¯èƒ½éƒ½ç†Ÿæ‚‰ï¼Œå› ä¸ºå®ƒéµå¾ª C è¯­è¨€åŠå…¶æ´¾ç”Ÿè¯­è¨€çš„è¯­æ³•ï¼Œæ­¤å¤–è¿˜å¯¹è¯­æ³•è¿›è¡Œäº†ä¸€äº›æ‰©å±•ã€‚

## 1. æ³¨é‡Š Comments

ANTLR æ”¯æŒå•è¡Œã€å¤šè¡Œä»¥åŠ Javadoc é£Žæ ¼çš„æ³¨é‡Šï¼š
```
/** è¿™æ˜¯è¯´æ˜Žä¸‰ç§æ³¨é‡Šçš„è¯­æ³•ç¤ºä¾‹
 */
grammar T;
/*å¤šè¡Œ
* æ³¨é‡Š
*/

/** æ­¤è§„åˆ™åŒ¹é…è‡ªå®šä¹‰è¯­è¨€ä¸­çš„ä¸€ä¸ªå£°æ˜Ž */
decl : ID ; // åŒ¹é…ä¸€ä¸ªå˜é‡å
```
Javadoc é£Žæ ¼çš„æ³¨é‡Šä¸ä¼šè¢«å¿½ç•¥ï¼Œä»–ä»¬ä¼šè¢«é€å…¥è¯­æ³•åˆ†æžå™¨ï¼Œå®ƒä»¬åªèƒ½å‡ºçŽ°åœ¨è¯­æ³•å’Œä»»æ„è§„åˆ™çš„å¼€å¤´

> Javadoc é£Žæ ¼çš„æ³¨é‡Šæ˜¯ Java ä»£ç çš„ä¸€ç§æ³¨é‡Šé£Žæ ¼ï¼Œå¯ä»¥ç”¨ javadoc å‘½ä»¤ç”Ÿæˆ API æ–‡æ¡£ã€‚

## 2. æ ‡è¯†ç¬¦ Identifiers

è¯æ¡ Token åç§°ä»¥åŠè¯æ³•è§£æžå™¨è§„åˆ™(è¯æ³•è§„åˆ™)åç§°æ€»æ˜¯ä»¥å¤§å†™å­—æ¯å¼€å¤´ï¼Œå…¶ä¸­å¤§å†™å­—æ¯ç”± Java çš„ Character.isUpperCase æ–¹æ³•å®šä¹‰ã€‚è¯­æ³•è§£æžå™¨è§„åˆ™(è¯­æ³•è§„åˆ™)åç§°æ€»æ˜¯ä»¥å°å†™å­—æ¯å¼€å¤´ï¼ˆCharacter.isUpperCase æ–¹æ³•è¿”å›ž falseï¼‰ã€‚é¦–å­—æ¯ä¹‹åŽçš„å­—ç¬¦å¯ä»¥æ˜¯å¤§å†™å­—æ¯ï¼Œä¹Ÿå¯ä»¥æ˜¯å°å†™å­—æ¯ï¼Œä¹Ÿå¯ä»¥æ˜¯æ•°å­—æˆ–è€…ä¸‹åˆ’çº¿ã€‚å¦‚ä¸‹æ˜¯ç®€å•çš„ä¾‹å­:
```
// è¯æ¡æˆ–è€…è¯æ³•è§£æžå™¨è§„åˆ™åç§°
ID, LPAREN, RIGHT_CURLY
// è¯­æ³•è§£æžå™¨è§„åˆ™åç§°
expr, simpleDeclarator, d2, header_file
```

> è¯æ³•è§„åˆ™åæ€»æ˜¯ä»¥å¤§å†™å­—æ¯å¼€å¤´ï¼›è¯­æ³•è§„åˆ™åæ€»æ˜¯ä»¥å°å†™å­—æ¯å¼€å¤´

ä¸Ž Java ç±»ä¼¼ï¼ŒANTLR ä¹Ÿå… Unicode å­—ç¬¦å‡ºçŽ°åœ¨æ ‡è¯†ç¬¦ä¸­ï¼š

![](https://github.com/sjf0115/ImageBucket/blob/main/Antlr/antlr-grammar-lexicon-1.png?raw=true)

ä¸ºäº†æ”¯æŒ Unicode çš„è¯æ³•è§£æžå™¨è§„åˆ™å’Œè¯­æ³•è§£æžå™¨è§„åˆ™ï¼ŒANTLR ä½¿ç”¨å¦‚ä¸‹è§„åˆ™ï¼š
```
ID : a=NameStartChar NameChar*
     {  
     if ( Character.isUpperCase(getText().charAt(0)) ) setType(TOKEN_REF);
     else setType(RULE_REF);
     }  
   ;
```
`NameChar` è§„åˆ™æ ‡è¯†å¯ä»¥ä½œä¸ºæ ‡è¯†ç¬¦çš„æœ‰æ•ˆå­—ç¬¦ï¼Œ`NameStartChar` è§„åˆ™æ ‡è¯†å¯ä»¥ä½œä¸ºæ ‡è¯†ç¬¦(è§„åˆ™ã€è¯æ¡æˆ–è€…æ ‡ç­¾åç§°)é¦–å­—æ¯çš„å­—ç¬¦åˆ—è¡¨ã€‚è¿™äº›å­—ç¬¦å¤§è‡´ä¸Ž Java Character ç±»çš„ isJavaIdentifierPart å’Œ isJavaIdentifierStart ç›¸å¯¹åº”ï¼š
```
fragment
NameChar
   : NameStartChar
   | '0'..'9'
   | '_'
   | '\u00B7'
   | '\u0300'..'\u036F'
   | '\u203F'..'\u2040'
   ;
fragment
NameStartChar
   : 'A'..'Z' | 'a'..'z'
   | '\u00C0'..'\u00D6'
   | '\u00D8'..'\u00F6'
   | '\u00F8'..'\u02FF'
   | '\u0370'..'\u037D'
   | '\u037F'..'\u1FFF'
   | '\u200C'..'\u200D'
   | '\u2070'..'\u218F'
   | '\u2C00'..'\u2FEF'
   | '\u3001'..'\uD7FF'
   | '\uF900'..'\uFDCF'
   | '\uFDF0'..'\uFFFD'
   ;
```
å¦‚æžœè¯­æ³•æ–‡ä»¶ä¸æ˜¯ `UTF-8` ç¼–ç æ ¼å¼ï¼Œè¯·ç¡®ä¿åœ¨ ANTLR å·¥å…·ä¸Šä½¿ç”¨ `-encoding` é€‰é¡¹ï¼Œä»¥ä¾¿ ANTLR æ­£ç¡®çš„è¯»å–å­—ç¬¦ã€‚

## 3. æ–‡æœ¬å¸¸é‡ Literals

ANTLR ä¸åƒå¤§å¤šæ•°è¯­è¨€é‚£æ ·åŒºåˆ†å­—ç¬¦å¸¸é‡å’Œå­—ç¬¦ä¸²å¸¸é‡ã€‚é•¿åº¦ä¸ºä¸€ä¸ªæˆ–å¤šä¸ªå­—ç¬¦çš„æ–‡æœ¬å­—ç¬¦ä¸²éƒ½ä½¿ç”¨å•å¼•å·åŒ…è£¹ï¼Œä¾‹å¦‚ `';'`ï¼Œ`'if'`ï¼Œ`'>='` ä»¥åŠ `'\"`(åŒ…å«å•å¼•å·å­—ç¬¦çš„å•å­—ç¬¦å­—ç¬¦ä¸²)ã€‚æ–‡æœ¬å¸¸é‡ä»Žä¸åŒ…å«æ­£åˆ™è¡¨è¾¾å¼ã€‚

æ–‡æœ¬å¸¸é‡å¯ä»¥åŒ…å«å½¢å¼ä¸º`'\uXXXX'`æˆ–`'\U{XXXXXX}'`çš„ Unicode è½¬ä¹‰åºåˆ—ï¼Œå…¶ä¸­'XXXX'æ˜¯åå…­è¿›åˆ¶çš„ Unicode å­—ç¬¦å€¼ã€‚ä¾‹å¦‚ï¼Œ`'\u00E8'` æ˜¯æ³•è¯­å­—æ¯ `Ã¨`ï¼Œè€Œ `\u{1F4A9}` æ˜¯è‘—åçš„è¡¨æƒ…ç¬¦å·`ðŸ’©`ã€‚

ANTLR è¿˜å¯ä»¥è¯†åˆ«å¸¸è§çš„ç‰¹æ®Šè½¬ä¹‰åºåˆ—ï¼š`'\n'`(æ¢è¡Œç¬¦)ã€`'\r'`(å›žè½¦)ã€`'\t'`(åˆ¶è¡¨ç¬¦)ã€`'\b'`(é€€æ ¼)å’Œ`'\f'`(æ¢è¡Œ)ã€‚ä½ å¯ä»¥ç›´æŽ¥ä½¿ç”¨å®ƒä»¬æˆ–è€…ä½¿ç”¨å®ƒä»¬çš„ Unicode è½¬ä¹‰åºåˆ—ï¼š
```
grammar Foreign;
a : 'å¤–' ;
```

ANTLR ç”Ÿæˆçš„è¯†åˆ«å™¨å‡è®¾è¯­æ³•ä¸­çš„å­—ç¬¦éƒ½æ˜¯ Unicode å­—ç¬¦ã€‚ANTLR è¿è¡Œæ—¶åº“å¯¹è¾“å…¥æ–‡ä»¶ç¼–ç åšå‡ºçš„å‡è®¾å–å†³äºŽç›®æ ‡è¯­è¨€ã€‚å¯¹äºŽ Java ç›®æ ‡è¯­è¨€ï¼Œè¿è¡Œæ—¶åº“å‡è®¾æ–‡ä»¶ç¼–ç æ˜¯ UTF-8 æ ¼å¼ã€‚ä½¿ç”¨ CharStreams ä¸­çš„å·¥åŽ‚æ–¹æ³•ï¼Œæ‚¨å¯ä»¥æŒ‡å®šä¸åŒçš„ç¼–ç æ ¼å¼ã€‚

## 4. åŠ¨ä½œ Actions

åŠ¨ä½œæ˜¯ä½¿ç”¨ç›®æ ‡è¯­è¨€ç¼–å†™çš„ä»£ç å—ã€‚æ‚¨å¯ä»¥åœ¨è¯­æ³•ä¸­çš„ä¸åŒåœ°æ–¹ä½¿ç”¨åŠ¨ä½œï¼Œä½†è¯­æ³•æ ¼å¼æ˜¯ä¸€æ ·çš„ï¼šç”¨èŠ±æ‹¬å·æ‹¬èµ·æ¥çš„ä»»æ„æ–‡æœ¬ã€‚å¦‚æžœå³èŠ±æ‹¬å·å­—ç¬¦åœ¨å­—ç¬¦ä¸²æˆ–æ³¨é‡Šä¸­ï¼Œåˆ™ä¸éœ€è¦è½¬ä¹‰: `"}"` æˆ–è€… `/*}*/`ã€‚åœ¨èŠ±æ‹¬å·å¹³è¡¡çš„æƒ…å†µä¸‹ï¼Œæ— éœ€è½¬ä¹‰ `}`ï¼Œä¾‹å¦‚ `{{...}}`ã€‚å…¶ä»–æƒ…å†µä¸‹ï¼Œé¢å¤–çš„èŠ±æ‹¬å·éœ€è¦ä½¿ç”¨åæ–œæ è½¬ä¹‰ï¼š`{\{}` æˆ– `{\}}`ã€‚åŠ¨ä½œä»£ç åº”è¯¥ç¬¦åˆè¯­è¨€é€‰é¡¹æŒ‡å®šçš„ç›®æ ‡è¯­è¨€çš„è¯­æ³•ã€‚

åµŒå…¥å¼ä»£ç å¯ä»¥å‡ºçŽ°åœ¨ï¼š`@header` å’Œ `@member` å‘½åçš„åŠ¨ä½œã€è¯æ³•è§£æžå™¨è§„åˆ™å’Œè¯­æ³•è§£æžå™¨è§„åˆ™ã€å¼‚å¸¸æ•èŽ·åŒºã€è¯­æ³•è§£æžå™¨è§„åˆ™çš„å±žæ€§éƒ¨åˆ†(è¿”å›žå€¼ã€å‚æ•°ä»¥åŠå±€éƒ¨å˜é‡)ä»¥åŠä¸€äº›è§„åˆ™å…ƒç´ çš„é€‰é¡¹ä¸­ã€‚

## 5. å…³é”®è¯

å¦‚ä¸‹æ˜¯ ANTLR è¯­æ³•ä¸­ä¿ç•™å…³é”®å­—åˆ—è¡¨ï¼š
```
import, fragment, lexer, parser, grammar, returns,
locals, throws, catch, finally, mode, options, tokens
```
å¦å¤–ï¼Œå°½ç®¡ `rule` ä¸æ˜¯å…³é”®å­—ï¼Œä½†ä¸è¦ä½¿ç”¨ `rule` ä½œä¸ºè§„åˆ™åã€‚æ­¤å¤–ï¼Œä¸è¦ä½¿ç”¨ç›®æ ‡è¯­è¨€(ä¾‹å¦‚ï¼ŒJava)ä¸­çš„ä»»ä½•å…³é”®å­—ä½œä¸ºè¯æ¡ Tokenã€æ ‡ç­¾æˆ–è€…è§„åˆ™åã€‚ä¾‹å¦‚ï¼Œ`if` è§„åˆ™å°†ç”Ÿæˆä¸€ä¸ªåä¸º `if` çš„å‡½æ•°ã€‚è¿™æ˜¾ç„¶ä¸èƒ½é€šè¿‡ç¼–è¯‘ã€‚


> åŽŸæ–‡ï¼š[Grammar Lexicon](https://github.com/antlr/antlr4/blob/master/doc/lexicon.md)
