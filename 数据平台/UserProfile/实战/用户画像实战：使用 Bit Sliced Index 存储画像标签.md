Roaring Bitmap 在用户画像分析场景，可以通过对标签表构建索引，将用户ID进行编码后以 Bitmap 格式保存，将关系运算转化为 Bitmap 的交并差运算，进而加速实时计算性能，详细请参阅[用户画像实战：使用 RoaringBitmap 存储画像标签](https://smartsi.blog.csdn.net/article/details/154582093)。但 Roaring Bitmap 会有以下局限：
- 多标签联合查询问题：Roaring Bitmap 更多用于属性标签，且仅可用于固定标签。对于大量行为标签，如PV、订单金额、观看时长等量值类标签，联合查询的解决方案只有回溯明细表，明细数据下钻成本增加。
- 高基数标签的查询问题：当某个标签的去重值数量（基数）很大时，Roaring Bitmap 的存储会膨胀，导致查询性能衰减。

针对上述局限，本文通过 BSI（Bit-sliced Index）算法与若干函数进行优化，详情请参见BSI函数，解决以下问题：
- 对于多标签联合查询场景，针对量值类行为标签进行预计算，通过 BSI 进行压缩存储，在保障精度的同时还可以避免与明细表进行关联查询，即可实现属性标签和行为标签的高效联动分析。
- 对于高基数的行为标签，通过位切片索引，最多生成 32 个位切片，即可存储全部用户在INT范围内的行为标签值，并且在查询时可以通过二进制原理和 Roaring Bitmap 交并差运算进行快速计算，实现对高基数行为标签的压缩存储和低延迟查询。


> 挑战：基数、范围查询、精确查询

Equality-Encoded Bitmap 缺点：
- 首先，不是很高效。根据基数的不同，需要创建许多 Bitmap 来表示所有可能的值。
- 其次，如果希望进行范围查询，那么必须对范围内的每个可能值执行或操作。为了知道圈养数量少于 100 的动物，查询需要执行类似于 Captivity=99 OR Captivity=98 OR Captivity=97 OR… 的或操作。
- 不能再基数极高的场景下使用

> 精确查询，但无法解决基数、范围查询问题

为每个分桶创建一个 Bitmap，而不是将每个可能的值表示为一个 Bitmap。
- 优点：
  - 效率更高，也更容易查询，因为不必为了一个范围查询而对多个 Bitmap 进行合并
- 缺点：
  - 粒度没有那么细，会丢失一部分原始值信息，虽然能进行范围查询，但是不能进行精准查询
  - 例如，将 47 转换为 0-99 分桶，将会丢失 47 这个原始值信息，不能实现精准查询圈养数量为 47 个的动物，但是可以查询圈养数量小于等于 99 个的动物。
- 不能在精确查询的场景下使用

> 解决数、范围查询问题，但无法精确查询

Range-Encoded Bitmap：
- 这种编码方法让我们可以像之前一样执行范围查询，但是不用在多个不同的 Bitmap 上执行或操作，在一个或两个 Bitmap 中就可以获得我们想要的结果。

> 无法解决基数问题
